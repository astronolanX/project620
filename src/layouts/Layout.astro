---
import '../styles/global.css';
import LeftNav from '../components/LeftNav.astro';
import { ViewTransitions } from 'astro:transitions';

export interface Props {
  title: string;
  description?: string;
}

const { title, description = "Personal portfolio and blog featuring projects, case studies, concepts, and explorations" } = Astro.props;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="keywords" content="design, technology, UX, UI, product design, web development, creative solutions" />
    <meta name="author" content="Nolan Figueroa" />
    
    <!-- SEO Meta Tags -->
    <meta name="robots" content="index, follow, max-image-preview:large" />
    
    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:site_name" content="Nolan Figueroa - Design & Technology" />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    
    <!-- Additional SEO -->
    <meta name="theme-color" content="#000000" />
    <link rel="canonical" href={Astro.url} />
    
    <!-- Security -->
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Optimized font loading -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Roboto+Mono:wght@400;600;700&family=Material+Icons&display=swap" rel="stylesheet">
    <title>{title}</title>
    <ViewTransitions />
    
    <!-- SPA initialization script -->
    <script>
      // Service Worker Registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => console.log('SW registered:', registration))
            .catch(error => console.log('SW registration failed:', error));
        });
      }
    </script>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay"></div>
    
    <!-- Left Navigation -->
    <LeftNav />
    
    <slot />
    

    
    <!-- Structured Data for SEO -->
    <script is:inline type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Person",
        "name": "Nolan Figueroa",
        "jobTitle": "Design & Technology Professional",
        "description": "I bridge design and tech to transform how people and organizations come together. I'm driven to solve messy problems by designing experiences that map new frontiers and build better futures.",
        "url": "https://astronolan.com",
        "sameAs": [
          "https://bsky.app/profile/astronolan.com",
          "https://www.linkedin.com/in/astronolan/"
        ],
        "knowsAbout": [
          "UX Design",
          "UI Design", 
          "Product Design",
          "Web Development",
          "Design Systems",
          "Creative Solutions"
        ]
      }
    </script>
    
    <!-- SPA State Management -->
    <script>
      // Initialize app state
      window.appState = window.appState || {
        currentPage: null,
        navigationHistory: [],
        isTransitioning: false
      };

      // Handle view transitions
      document.addEventListener('astro:page-load', () => {
        // Update app state
        window.appState.currentPage = window.location.pathname;
        window.appState.navigationHistory.push(window.location.pathname);
        
        // Remove loading overlay if it exists
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.add('hidden');
          setTimeout(() => overlay.remove(), 300);
        }
      });

      // Handle transition start
      document.addEventListener('astro:before-preparation', () => {
        window.appState.isTransitioning = true;
      });

      // Handle transition complete
      document.addEventListener('astro:after-swap', () => {
        window.appState.isTransitioning = false;
        // Reinitialize cursor after page swap
        initCustomCursor();
      });

      // Custom Cursor Implementation
      let mouseX = 0;
      let mouseY = 0;
      let cursorX = 0;
      let cursorY = 0;
      let animationId: number | null = null;
      
             // Detect if device has touch capability and no mouse
       function isTouchDevice() {
         // Check for touch capability
         const hasTouch = ('ontouchstart' in window) || 
                         (navigator.maxTouchPoints > 0);
        
        // Check if device has a fine pointer (mouse)
        const hasMouse = window.matchMedia('(pointer: fine)').matches;
        
        // Check viewport dimensions (tablet/mobile detection)
        const isSmallViewport = window.innerWidth <= 768;
        const isPortrait = window.innerHeight > window.innerWidth;
        
        // Check if device is primarily touch
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // More comprehensive detection for tablet/mobile scenarios
        const isProbablyTouchPrimary = hasTouch && (
          !hasMouse || 
          isMobile || 
          (isSmallViewport && hasTouch) ||
          (isPortrait && hasTouch && isSmallViewport)
        );
        
        // Only disable cursor if it's a touch device without a mouse
        return isProbablyTouchPrimary;
      }
      
      function initCustomCursor() {
        // Don't initialize cursor for touch devices
        if (isTouchDevice()) {
          // Remove any existing cursor
          const existingCursor = document.getElementById('custom-cursor');
          if (existingCursor) {
            existingCursor.remove();
          }
          // Cancel any animation frames
          if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
          }
          return;
        }
        
        const cursor = document.getElementById('custom-cursor');
        if (!cursor) {
          // Create cursor if it doesn't exist
          const newCursor = document.createElement('div');
          newCursor.id = 'custom-cursor';
          newCursor.className = 'custom-cursor';
          document.body.insertBefore(newCursor, document.body.firstChild);
        }
        
        // Cancel any existing animation frame
        if (animationId) {
          cancelAnimationFrame(animationId);
        }
        
        const cursorElement = document.getElementById('custom-cursor');
        
        // Direct cursor positioning (matches system speed)
        function animateCursor() {
          cursorX = mouseX;
          cursorY = mouseY;
          
          if (cursorElement) {
            cursorElement.style.transform = `translate(${cursorX}px, ${cursorY}px)`;
          }
          
          animationId = requestAnimationFrame(animateCursor);
        }
        animateCursor();
      }
      
      // Track mouse movement globally
      document.addEventListener('mousemove', (e) => {
        // Skip on touch devices
        if (isTouchDevice()) return;
        
        mouseX = e.clientX;
        mouseY = e.clientY;
        
        // Set initial position on first move
        if (cursorX === 0 && cursorY === 0) {
          cursorX = mouseX;
          cursorY = mouseY;
        }
      });
      
      // Click animation
      document.addEventListener('mousedown', () => {
        // Skip on touch devices
        if (isTouchDevice()) return;
        
        const cursor = document.getElementById('custom-cursor');
        if (cursor) {
          cursor.classList.remove('releasing');
          cursor.classList.add('clicking');
        }
      });
      
      document.addEventListener('mouseup', () => {
        // Skip on touch devices
        if (isTouchDevice()) return;
        
        const cursor = document.getElementById('custom-cursor');
        if (cursor) {
          cursor.classList.remove('clicking');
          cursor.classList.add('releasing');
        }
      });
      
      // Hide cursor when it leaves the window
      document.addEventListener('mouseleave', () => {
        // Skip on touch devices
        if (isTouchDevice()) return;
        
        const cursor = document.getElementById('custom-cursor');
        if (cursor) {
          cursor.style.opacity = '0';
        }
      });
      
      document.addEventListener('mouseenter', () => {
        // Skip on touch devices
        if (isTouchDevice()) return;
        
        const cursor = document.getElementById('custom-cursor');
        if (cursor) {
          cursor.style.opacity = '1';
        }
      });
      
      // Debounce viewport change detection
      let viewportChangeTimeout: number | null = null;
      
      // Re-evaluate cursor necessity on window resize or orientation change
      function handleViewportChange() {
        // Clear existing timeout
        if (viewportChangeTimeout) {
          clearTimeout(viewportChangeTimeout);
        }
        
        // Debounce re-evaluation to avoid excessive calls
        viewportChangeTimeout = setTimeout(() => {
          // Re-initialize cursor detection when viewport changes
          initCustomCursor();
        }, 150); // 150ms debounce
      }
      
      // Initialize on first load
      document.addEventListener('DOMContentLoaded', initCustomCursor);
      
      // Also initialize on astro:page-load for initial page load
      document.addEventListener('astro:page-load', initCustomCursor);
      
      // Re-evaluate cursor on viewport changes
      window.addEventListener('resize', handleViewportChange);
      window.addEventListener('orientationchange', handleViewportChange);
    </script>
  </body>
</html>

<style is:global>
  :root {
    --border-radius: 20px;
    --border-radius-sm: 12px;
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
    --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
  }

  /* Astro View Transitions animations */
  ::view-transition-old(root),
  ::view-transition-new(root) {
    animation-duration: 0.3s;
    animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  }

  ::view-transition-old(root) {
    animation-name: fade-out-scale;
  }

  ::view-transition-new(root) {
    animation-name: fade-in-scale;
  }

  @keyframes fade-out-scale {
    from {
      opacity: 1;
      transform: scale(1);
    }
    to {
      opacity: 0;
      transform: scale(0.95);
    }
  }

  @keyframes fade-in-scale {
    from {
      opacity: 0;
      transform: scale(1.05);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Persist left nav during transitions */
  .left-nav {
    view-transition-name: left-nav;
  }

  ::view-transition-old(left-nav),
  ::view-transition-new(left-nav) {
    animation: none;
  }
  
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    color: var(--gray-900);
  }
  
  /* Apply Roboto to all body copy and interactive elements */
  body, p, span, div, input, textarea, button, select, label, a, li, blockquote, 
  .nav-links, .contact-link, .form-group, .submit-btn, .card-content {
    font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }
  
  h1, h2, h3, h4, h5, h6 {
    font-family: 'Roboto Mono', 'Courier New', monospace;
    font-weight: 700;
  }
  
  /* Loading Overlay Styles */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--text-black);
    color: var(--bg-white);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease-out;
  }
  
  .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }
  
  .loading-content {
    text-align: center;
    font-family: 'JetBrains Mono', monospace;
  }
  
  .loading-number {
    font-size: clamp(4rem, 12vw, 8rem);
    font-weight: 600;
    line-height: 1;
    margin-bottom: 1rem;
    font-feature-settings: 'tnum';
    font-variant-numeric: tabular-nums;
  }
  
  .loading-text {
    font-size: clamp(0.9rem, 2vw, 1.2rem);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.7;
  }
  
  /* Custom Cursor Styles */
  .custom-cursor {
    position: fixed;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: rgba(198, 255, 0, 0.75);
    pointer-events: none;
    z-index: 10000;
    left: 0;
    top: 0;
    margin-left: -12px;
    margin-top: -12px;
    transition: opacity 0.3s ease;
    will-change: transform;
    mix-blend-mode: normal;
    view-transition-name: custom-cursor;
  }
  
  /* Hide cursor on touch devices */
  @media (hover: none) and (pointer: coarse) {
    .custom-cursor {
      display: none !important;
    }
  }
  
  /* Hide cursor on mobile devices */
  @media (max-width: 768px) and (hover: none) {
    .custom-cursor {
      display: none !important;
    }
  }
  
  /* Persist cursor during transitions */
  ::view-transition-old(custom-cursor),
  ::view-transition-new(custom-cursor) {
    animation: none;
  }
  
  .custom-cursor.clicking {
    animation: cursor-shrink 0.15s ease forwards;
  }
  
  .custom-cursor.releasing {
    animation: cursor-grow 0.15s ease forwards;
  }
  
  @keyframes cursor-shrink {
    0% {
      width: 24px;
      height: 24px;
      margin-left: -12px;
      margin-top: -12px;
      background-color: rgba(198, 255, 0, 0.75);
    }
    50% {
      width: 19px;
      height: 19px;
      margin-left: -9.5px;
      margin-top: -9.5px;
      background-color: rgba(101, 128, 0, 0.75);
    }
    100% {
      width: 14px;
      height: 14px;
      margin-left: -7px;
      margin-top: -7px;
      background-color: rgba(0, 0, 0, 0.75);
    }
  }
  
  @keyframes cursor-grow {
    0% {
      width: 14px;
      height: 14px;
      margin-left: -7px;
      margin-top: -7px;
      background-color: rgba(0, 0, 0, 0.75);
    }
    50% {
      width: 19px;
      height: 19px;
      margin-left: -9.5px;
      margin-top: -9.5px;
      background-color: rgba(101, 128, 0, 0.75);
    }
    100% {
      width: 24px;
      height: 24px;
      margin-left: -12px;
      margin-top: -12px;
      background-color: rgba(198, 255, 0, 0.75);
    }
  }
  
  /* Hide default cursor globally */
  * {
    cursor: none !important;
  }
</style>