---
// Get user initials for the nav
const name = "N/N"; // Initials with forward slash

// Selected works mapped to actual project slugs
const selectedWorks = [
  { number: 1, slug: "future-design" },
  { number: 2, slug: "ux-patterns" },
  { number: 3, slug: "spatial-interfaces" }
];

// Get current page info for highlighting
const currentPath = Astro.url.pathname;
const isHomePage = currentPath === '/';
const isArchivePage = currentPath === '/archive' || currentPath === '/archive/';
const isProjectPage = currentPath.startsWith('/projects/');
const currentProjectSlug = isProjectPage ? currentPath.split('/projects/')[1]?.replace('/', '') : null;
---

<div class="left-nav">
  <a href="/" class={`menu-home ${isHomePage ? 'active' : ''}`}>
    <span class="name" data-text={name}>
      <span>N</span>
      <span class="slash"> / </span>
      <span>N</span>
    </span>
  </a>
  
  <nav class="menu-numbers">
    {selectedWorks.map((work) => (
      <a href={`/projects/${work.slug}`} class={`menu-number ${currentProjectSlug === work.slug ? 'active' : ''}`} data-number={work.number}>
        <span class="number" data-number={`/ ${work.number}`}>/ {work.number}</span>
      </a>
    ))}
  </nav>
  
  <a href="/archive" class={`menu-archive ${isArchivePage ? 'active' : ''}`}>
    <svg class="archive-icon" width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M3.25 10.0957C3.56503 10.1975 3.9011 10.2525 4.25 10.2525H19.75C20.0989 10.2525 20.435 10.1975 20.75 10.0957V19.0025C20.75 20.2451 19.7426 21.2525 18.5 21.2525H5.5C4.25736 21.2525 3.25 20.2451 3.25 19.0025V10.0957ZM9.25 13.7525C9.25 14.1667 9.58579 14.5025 10 14.5025H14C14.4142 14.5025 14.75 14.1667 14.75 13.7525C14.75 13.3382 14.4142 13.0025 14 13.0025H10C9.58579 13.0025 9.25 13.3382 9.25 13.7525Z" fill="currentColor"/>
      <path opacity="0.4" d="M20.75 9.01807C20.7744 9.00594 20.7986 8.99337 20.8225 8.98039C21.5239 8.59938 22 7.85627 22 7.00195V6.00195C22 4.75931 20.9926 3.75195 19.75 3.75195H4.25C3.00736 3.75195 2 4.75931 2 6.00195V7.00195C2 7.88538 2.50914 8.6499 3.25 9.01807C3.55124 9.16778 3.89079 9.25195 4.25 9.25195H19.75C20.1092 9.25195 20.4488 9.16778 20.75 9.01807Z" fill="currentColor"/>
    </svg>
  </a>
  
  <button class="menu-footer-toggle" id="footerToggle">
    <svg class="info-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <g opacity="0.4">
        <path d="M12.0008 2C9.60139 2 7.65625 3.94514 7.65625 6.34459C7.65625 8.74404 9.60139 10.6892 12.0008 10.6892C14.4003 10.6892 16.3454 8.74404 16.3454 6.34459C16.3454 3.94514 14.4003 2 12.0008 2Z" fill="currentColor"/>
        <path d="M8.93359 12.189C6.0341 12.189 3.68359 14.5395 3.68359 17.439V18.75C3.68359 19.9926 4.69095 21 5.93359 21H11.3215C10.3398 19.8113 9.75 18.287 9.75 16.625C9.75 14.9344 10.3602 13.3863 11.3725 12.189H8.93359Z" fill="currentColor"/>
      </g>
      <path d="M11.25 16.625C11.25 13.6565 13.6565 11.25 16.625 11.25C19.5935 11.25 22 13.6565 22 16.625C22 19.5935 19.5935 22 16.625 22C13.6565 22 11.25 19.5935 11.25 16.625ZM15.824 14.4992C15.824 14.941 16.1822 15.2992 16.624 15.2992H16.634C17.0759 15.2992 17.434 14.941 17.434 14.4992C17.434 14.0574 17.0759 13.6992 16.634 13.6992H16.624C16.1822 13.6992 15.824 14.0574 15.824 14.4992ZM16.625 16.2504C16.2108 16.2504 15.875 16.5862 15.875 17.0004V18.7487C15.875 19.1629 16.2108 19.4987 16.625 19.4987C17.0392 19.4987 17.375 19.1629 17.375 18.7487V17.0004C17.375 16.5862 17.0392 16.2504 16.625 16.2504Z" fill="currentColor"/>
    </svg>
  </button>
</div>

<!-- Navigation Loading Indicator -->
<div class="navigation-loading" id="navigationLoading"></div>

<style>
  /* Ensure nav is not affected by any parent transforms */
  :global(html), :global(body) {
    transform: none !important;
    perspective: none !important;
    overflow-x: hidden;
  }

  .left-nav {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    bottom: 0 !important;
    right: auto !important;
    height: 100vh;
    height: 100dvh; /* Dynamic viewport height for mobile */
    height: -webkit-fill-available; /* iOS Safari fix */
    height: calc(var(--vh, 1vh) * 100); /* Custom viewport height */
    min-height: 100vh;
    min-height: 100dvh;
    min-height: -webkit-fill-available;
    width: 88px;
    z-index: 1000;
    background: #ffffff;
    padding: 24px 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
    border-right: 1px solid #e5e5e5;
    border-radius: 0;
    box-sizing: border-box;
    transform: translateZ(0) !important; /* Force GPU acceleration but no transform */
    -webkit-transform: translateZ(0) !important;
    will-change: auto !important;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
  }

  /* Active states for navigation items */
  .left-nav .active:not(.menu-footer-toggle):not(.no-animation):not(.menu-home) {
    background: #000000;
    animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Active state without animation (for preventing double animations) */
  .left-nav .active.no-animation:not(.menu-footer-toggle):not(.menu-home) {
    background: #000000;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Special active state for N/N logo */
  .menu-home.active {
    background: #c6ff00;
    animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .menu-home.active.no-animation {
    background: #c6ff00;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .menu-home.active:hover {
    background: #a6d900;
  }
  
  
  @keyframes scaleIn {
    from {
      transform: scale(0);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }
  
  /* Click animation for active items - re-triggers the scale animation */
  .left-nav .active.clicked:not(.menu-footer-toggle) {
    animation: clickPulse 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }
  
  @keyframes clickPulse {
    0% {
      transform: scale(1);
    }
    30% {
      transform: scale(0.85);
    }
    60% {
      transform: scale(1.1);
    }
    100% {
      transform: scale(1);
    }
  }
  
  /* Click animation for non-active items */
  .left-nav .clicked:not(.active) {
    animation: clickBounce 0.3s ease-out;
  }
  
  @keyframes clickBounce {
    0% {
      transform: scale(1);
    }
    40% {
      transform: scale(0.9);
    }
    100% {
      transform: scale(1);
    }
  }
  

  .menu-home {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 56px;
    height: 56px;
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    background: transparent;
    margin-bottom: 16px;
  }
  
  .menu-home:hover:not(.active) {
    background: #f5f5f5;
  }
  
  .menu-home.active:hover .name {
    transform: var(--center-transform);
    transform-origin: center center;
  }
  
  
  .menu-home:hover .name {
    color: #000;
    font-weight: 700;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .menu-home.active .name {
    color: #000;
    font-weight: 700;
  }
  
  /* Common centered positioning for menu items */
  .name,
  .archive-icon,
  .number,
  .info-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: var(--center-transform);
    transform-origin: center center;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    line-height: 1;
  }
  
  .name {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 16px;
    font-weight: 700;
    font-style: italic;
    color: #333;
    letter-spacing: -0.2px;
    writing-mode: horizontal-tb;
    text-orientation: mixed;
    height: auto;
    width: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    transform: var(--center-transform);
    position: absolute;
    top: 50%;
    left: 50%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    gap: 2px;
  }
  
  .name .slash {
    margin: 0 1px;
  }

  .menu-archive {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    background: transparent;
    margin-top: 8px;
  }
  
  .menu-archive:hover:not(.active) {
    background: #f5f5f5;
  }
  
  .menu-archive.active:hover .archive-icon {
    transform: var(--center-transform);
    transform-origin: center center;
  }
  
  
  .archive-icon {
    width: 24px;
    height: 24px;
    color: #000;
  }
  
  .menu-archive:hover .archive-icon {
    color: #999;
  }
  
  .menu-archive.active .archive-icon {
    color: #c6ff00;
  }
  
  .menu-numbers {
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
    flex: 1;
    padding: 20px 0;
  }
  
  .menu-number {
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 12px;
    line-height: 1;
    position: relative;
    width: 48px;
    height: 48px;
    background: transparent;
  }
  
  .menu-number:hover:not(.active) {
    background: #f5f5f5;
  }
  
  .menu-number.active:hover .number {
    transform: var(--center-transform);
    transform-origin: center center;
  }
  
  .number {
    font-family: 'Roboto Condensed', sans-serif;
    font-weight: 700;
    font-style: normal;
    color: #999;
    font-size: 15px;
  }
  
  .menu-number:hover .number {
    color: #666;
    font-weight: 700;
  }
  
  .menu-number.active .number {
    color: #c6ff00;
    font-weight: 700;
  }
  
  
  /* Smooth transitions for all sizing and background changes */
  .menu-number {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .menu-number .number {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Enhanced transitions for size changes */
  .menu-numbers[data-selected] .menu-number {
    transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                background 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .menu-numbers[data-selected] .menu-number .number {
    transition: font-size 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  
  .menu-footer-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    background: transparent;
    border: none;
    border-radius: 12px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    padding: 0;
    position: relative;
    margin-top: auto;
  }
  
  .menu-footer-toggle:hover:not(.active) {
    background: #f5f5f5;
  }
  
  
  .menu-footer-toggle.active:hover .info-icon {
    transform: var(--center-transform);
    transform-origin: center center;
  }
  
  .menu-footer-toggle.active.bounce {
    animation: bounce 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  
  .info-icon {
    width: 24px;
    height: 24px;
    color: #000;
  }
  
  .menu-footer-toggle:hover .info-icon {
    color: #999;
  }
  
  .menu-footer-toggle.active {
    background: #000;
  }
  
  .menu-footer-toggle.active .info-icon {
    color: #c6ff00;
  }
  
  /* Loading indicator */
  .navigation-loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(
      90deg, 
      transparent 0%, 
      #c6ff00 50%, 
      transparent 100%
    );
    transform: translateX(-100%);
    animation: loading-slide 1s ease-in-out infinite;
    z-index: 10001;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .navigation-loading.active {
    opacity: 1;
  }
  
  @keyframes loading-slide {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100vw); }
  }
  
  @keyframes shrink {
    0% { transform: scale(1); }
    50% { transform: scale(0.9); }
    100% { transform: scale(1); }
  }
  
  
  .menu-home.active.shrink {
    animation: shrink 0.15s ease-out;
  }
  
  .menu-number.active.shrink {
    animation: shrink 0.15s ease-out;
  }
  
  .menu-archive.active.shrink {
    animation: shrink 0.15s ease-out;
  }
  
  .menu-footer-toggle.active.shrink {
    animation: shrink 0.15s ease-out;
  }
  
  
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .left-nav {
      width: 72px;
      padding: 20px 0;
      gap: 8px;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      bottom: 0 !important;
      right: auto !important;
      height: 100vh;
      height: 100dvh; /* Ensure full viewport height on mobile */
      height: -webkit-fill-available; /* iOS Safari fix */
      min-height: 100vh;
      min-height: 100dvh;
      min-height: -webkit-fill-available;
      transform: translateZ(0) !important;
      -webkit-transform: translateZ(0) !important;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .menu-home {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
    }
    
    .name {
      font-size: 14px;
      letter-spacing: -0.1px;
    }
    
    .menu-number {
      width: 40px;
      height: 40px;
    }
    
    .number {
      font-size: 13px;
    }
    
    .menu-archive {
      width: 40px;
      height: 40px;
    }
    
    .archive-icon {
      width: 24px;
      height: 24px;
    }
    
    .menu-footer-toggle {
      width: 40px;
      height: 40px;
    }
    
    .menu-footer-toggle .info-icon {
      width: 24px;
      height: 24px;
    }
    
  }
  
</style>

<script>
  // Initialize global SPA state for menu
  window.menuState = window.menuState || {
    footerVisible: false,
    initialized: false
  };

  // Fix for iOS viewport height
  function setViewportHeight() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
    
    // Force the nav to use actual viewport height
    const nav = document.querySelector('.left-nav') as HTMLElement;
    if (nav) {
      nav.style.height = `${window.innerHeight}px`;
    }
  }

  // Set on load
  setViewportHeight();

  // Update on resize and orientation change
  window.addEventListener('resize', setViewportHeight);
  window.addEventListener('orientationchange', setViewportHeight);

  class LeftNav {
    private footerToggle: HTMLElement | null;
    
    constructor() {
      this.footerToggle = document.getElementById('footerToggle');
      this.initFooterToggle();
      this.initKeyboardHandlers();
      this.initNavigationHandlers();
      
      // Restore footer state
      if (window.menuState.footerVisible) {
        const footer = document.querySelector('.footer-section');
        if (footer) {
          footer.classList.add('visible');
          this.footerToggle?.classList.add('active');
        }
      }
    }
    
    initFooterToggle() {
      if (this.footerToggle) {
        this.footerToggle.addEventListener('click', () => {
          this.toggleFooter();
        });
      }
    }
    
    toggleFooter() {
      const footer = document.querySelector('.footer-section');
      if (!footer) return;
      
      // Update global state
      window.menuState.footerVisible = !window.menuState.footerVisible;
      
      if (window.menuState.footerVisible) {
        footer.classList.add('visible');
        this.footerToggle?.classList.add('active');
      } else {
        footer.classList.remove('visible');
        this.footerToggle?.classList.remove('active');
      }
    }
    
    initKeyboardHandlers() {
      document.addEventListener('keydown', (e) => {
        // Close footer on Escape key
        if (e.key === 'Escape' && window.menuState.footerVisible) {
          this.toggleFooter();
        }
      });
      
      // Listen for footer close button clicks
      document.addEventListener('footer-close', () => {
        if (window.menuState.footerVisible) {
          this.toggleFooter();
        }
      });
    }
    
    initNavigationHandlers() {
      // Handle clicks on all navigation items
      const navItems = document.querySelectorAll('.menu-home, .menu-number, .menu-archive');
      
      navItems.forEach(item => {
        item.addEventListener('click', (e) => {
          const clickedItem = e.currentTarget as HTMLAnchorElement;
          const href = clickedItem.href;
          const currentUrl = window.location.href;
          
          // Add shrink animation to all clicked items
          clickedItem.classList.add('shrink');
          
          // Remove animation class after animation completes
          setTimeout(() => {
            clickedItem.classList.remove('shrink');
          }, 150);
          
          // If clicking on the already active page, prevent navigation
          if (href === currentUrl && clickedItem.classList.contains('active')) {
            e.preventDefault();
            
            // Close footer if open
            if (window.menuState.footerVisible) {
              this.toggleFooter();
            }
            return;
          }
          
          // If footer is open, close it first and wait for animation before navigating
          if (window.menuState.footerVisible) {
            e.preventDefault(); // Prevent immediate navigation
            
            // Close footer
            window.menuState.footerVisible = false;
            this.footerToggle?.classList.remove('active');
            const footer = document.querySelector('.footer-section');
            footer?.classList.remove('visible');
            
            // Wait for footer close animation to complete (400ms from CSS transition)
            setTimeout(() => {
              // Navigate after footer is closed
              window.location.href = href;
            }, 400);
          }
        });
      });
    }
  }
  
  // Initialize on page load (works with View Transitions)
  document.addEventListener('astro:page-load', () => {
    new LeftNav();
    
    // Mark as initialized after first load
    if (!window.menuState.initialized) {
      window.menuState.initialized = true;
    }
  });
  
  // Handle before page swap to show navigation loading
  document.addEventListener('astro:before-swap', () => {
    const loadingBar = document.getElementById('navigationLoading');
    if (loadingBar) {
      loadingBar.classList.add('active');
    }
  });
  
  // Handle after swap to hide loading
  document.addEventListener('astro:after-swap', () => {
    const loadingBar = document.getElementById('navigationLoading');
    if (loadingBar) {
      loadingBar.classList.remove('active');
    }
  });
</script>